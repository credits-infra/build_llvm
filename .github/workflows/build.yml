name: Build & upload toolchain for Apple Container
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: |
        bash ci.sh deps
        sudo apt-get install -y patchelf
    - name: Build LLVM
      run: bash ./build-toolchain.sh
    - name: Package toolchain
      run: |
        # Get build info
        DATE=$(date +%Y%m%d)
        if [ -f ./install/bin/clang ]; then
          CLANG_VERSION=$("./install/bin/clang" --version | head -n1 | cut -d' ' -f4)
        else
          CLANG_VERSION="unknown"
        fi

        # Create tarball
        tar -czf clang-toolchain-${DATE}.tar.gz -C install .

        # Save build info to global env variable
        echo "CLANG_VERSION=${CLANG_VERSION}" >> $GITHUB_ENV
        echo "BUILD_DATE=${DATE}" >> $GITHUB_ENV
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.BUILD_DATE }}
        name: "Toolchain Build ${{ env.BUILD_DATE }}"
        body: |
          Automated build of LLVM + Clang ${{ env.CLANG_VERSION }}.

          This release contains a prebuilt Clang toolchain with AArch64, ARM, and X86 targets.
        files: clang-toolchain-${{ env.BUILD_DATE }}.tar.gz
        draft: false
        prerelease: false